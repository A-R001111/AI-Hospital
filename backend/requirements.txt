# =====================================
# Dockerfile for Parspack PaaS
# نسخه بهینه شده برای حل مشکل Out of Memory - exit code 137
# =====================================

FROM python:3.11-slim

# تنظیم متغیرهای محیطی پایتون برای رفتار مطلوب در کانتینر
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    DEBIAN_FRONTEND=noninteractive

# آرگومان برای فعال/غیرفعال کردن نصب Torch در زمان build
ARG INSTALL_TORCH=false

# =====================================
# نصب بسته‌های سیستمی به صورت تدریجی (حل مشکل Memory)
# =====================================

# مرحله 1: نصب dependencies اصلی
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# مرحله 2: نصب ffmpeg و dependencies مرتبط
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    libmagic1 \
    libgomp1 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# مرحله 3: نصب PostgreSQL client (اختیاری - برای دیباگ)
RUN apt-get update && apt-get install -y --no-install-recommends \
    postgresql-client \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# =====================================
# ست کردن مسیر کاری
# =====================================
WORKDIR /app

# کپی requirements قبل از کپی کد برای استفاده از layer caching Docker
COPY backend/requirements.txt ./backend/requirements.txt

# ارتقا pip با روش پیشنهادی (python -m pip) و امن‌سازی نصب پکیج‌ها
RUN python -m pip install --upgrade pip setuptools wheel

# =====================================
# نصب اختیاری PyTorch/torchaudio (CPU) از شاخص رسمی PyTorch
# =====================================
# نکته: این مرحله تنها زمانی اجرا می‌شود که هنگام build آرگومان INSTALL_TORCH=true ارسال شده باشد.
RUN if [ "${INSTALL_TORCH}" = "true" ]; then \
      python -m pip install --no-cache-dir "torch==2.1.1+cpu" "torchaudio==2.1.1+cpu" -f https://download.pytorch.org/whl/torch_stable.html ; \
    else \
      echo "Skipping torch install (INSTALL_TORCH not true)"; \
    fi

# نصب باقی requirements بدون حل مجدد وابستگی‌ها
RUN python -m pip install --no-cache-dir --no-deps -r ./backend/requirements.txt

# حالا کدهای backend را کپی می‌کنیم
COPY backend/app ./app

# کپی frontend (در صورت وجود)
COPY frontend ./frontend

# فولدرهای runtime و تنظیم دسترسی مناسب
RUN mkdir -p /app/logs /app/uploads && chmod -R 755 /app/logs /app/uploads

# تنظیم PYTHONPATH برای اطمینان از ایمپورت درست ماژول‌ها
ENV PYTHONPATH=/app

# Health check ساده
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://127.0.0.1:8000/health || exit 1

# پورت اپلیکیشن
EXPOSE 8000

# =====================================
# دستور اجرای برنامه - Workers کاهش یافت برای کاهش مصرف حافظه
# =====================================
CMD ["gunicorn", "app.main:app", \
    "--workers", "2", \
    "--worker-class", "uvicorn.workers.UvicornWorker", \
    "--bind", "0.0.0.0:8000", \
    "--access-logfile", "-", \
    "--error-logfile", "-", \
    "--log-level", "info", \
    "--timeout", "120", \
    "--keep-alive", "5"]