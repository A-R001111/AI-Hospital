#!/bin/bash

# ================================================================================
# ุงุณฺฉุฑูพุช ุฑุงูโุงูุฏุงุฒ ุณุฑุน - ุณุงูุงูู ฺฏุฒุงุฑุดโููุณ ูพุฑุณุชุงุฑุงู
# ================================================================================

set -e  # ุชููู ุฏุฑ ุตูุฑุช ุฎุทุง

echo "๐ ุดุฑูุน ุฑุงูโุงูุฏุงุฒ ุณุงูุงูู ฺฏุฒุงุฑุดโููุณ ูพุฑุณุชุงุฑุงู..."
echo ""

# ุฑูฺฏโูุง ุจุฑุง ุฎุฑูุฌ
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# ================================================================================
# 1. ุจุฑุฑุณ ูุตุจ Docker
# ================================================================================
echo -e "${BLUE}๐ฆ ุจุฑุฑุณ Docker...${NC}"
if ! command -v docker &> /dev/null; then
    echo -e "${RED}โ Docker ูุตุจ ูุณุช!${NC}"
    echo "ูุทูุงู ุงุจุชุฏุง Docker ุฑุง ูุตุจ ฺฉูุฏ: https://docs.docker.com/get-docker/"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo -e "${RED}โ Docker Compose ูุตุจ ูุณุช!${NC}"
    echo "ูุทูุงู ุงุจุชุฏุง Docker Compose ุฑุง ูุตุจ ฺฉูุฏ"
    exit 1
fi

echo -e "${GREEN}โ Docker ููุฌูุฏ ุงุณุช${NC}"
echo ""

# ================================================================================
# 2. ุจุฑุฑุณ ูุงู .env
# ================================================================================
echo -e "${BLUE}๐ง ุจุฑุฑุณ ุชูุธูุงุช...${NC}"
if [ ! -f ".env" ]; then
    echo -e "${YELLOW}โ๏ธ  ูุงู .env ูุฌูุฏ ูุฏุงุฑุฏุ ุฏุฑ ุญุงู ุงุฌุงุฏ...${NC}"
    cp .env.example .env
    echo -e "${GREEN}โ ูุงู .env ุงุฌุงุฏ ุดุฏ${NC}"
    echo -e "${YELLOW}โ๏ธ  ูุทูุงู ูุงู .env ุฑุง ูุฑุงุด ฺฉูุฏ ู ููุงุฏุฑ ุฑุง ุชูุธู ฺฉูุฏ${NC}"
    echo ""
    echo "ูููโุชุฑู ุชูุธูุงุช:"
    echo "  - OPENAI_API_KEY: ฺฉูุฏ API OpenAI"
    echo "  - SECRET_KEY: ฺฉูุฏ ูุฎู (32 ฺฉุงุฑุงฺฉุชุฑ)"
    echo "  - DATABASE_URL: ุขุฏุฑุณ ุฏุชุงุจุณ"
    echo ""
    read -p "ุขุง ูุงู .env ุฑุง ูุฑุงุด ฺฉุฑุฏุฏุ (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}ูุทูุงู ุงุจุชุฏุง .env ุฑุง ุชูุธู ฺฉูุฏ${NC}"
        exit 1
    fi
fi
echo -e "${GREEN}โ ูุงู ุชูุธูุงุช ููุฌูุฏ ุงุณุช${NC}"
echo ""

# ================================================================================
# 3. ุฑุงูโุงูุฏุงุฒ ุฏุชุงุจุณ
# ================================================================================
echo -e "${BLUE}๐๏ธ  ุฑุงูโุงูุฏุงุฒ ุฏุชุงุจุณ...${NC}"
docker-compose up -d postgres redis

echo "โณ ุตุจุฑ ฺฉูุฏ ุชุง ุฏุชุงุจุณ ุขูุงุฏู ุดูุฏ..."
sleep 5

# ุจุฑุฑุณ ูุถุนุช
if docker-compose ps | grep -q "postgres.*Up"; then
    echo -e "${GREEN}โ PostgreSQL ุขูุงุฏู ุงุณุช${NC}"
else
    echo -e "${RED}โ ุฎุทุง ุฏุฑ ุฑุงูโุงูุฏุงุฒ PostgreSQL${NC}"
    docker-compose logs postgres
    exit 1
fi

if docker-compose ps | grep -q "redis.*Up"; then
    echo -e "${GREEN}โ Redis ุขูุงุฏู ุงุณุช${NC}"
else
    echo -e "${RED}โ ุฎุทุง ุฏุฑ ุฑุงูโุงูุฏุงุฒ Redis${NC}"
    docker-compose logs redis
    exit 1
fi
echo ""

# ================================================================================
# 4. ุฑุงูโุงูุฏุงุฒ Backend
# ================================================================================
echo -e "${BLUE}โ๏ธ  ุฑุงูโุงูุฏุงุฒ Backend...${NC}"

# ุจุฑุฑุณ Python
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}โ Python3 ูุตุจ ูุณุช!${NC}"
    exit 1
fi

# ุงุฌุงุฏ virtual environment
cd backend
if [ ! -d "venv" ]; then
    echo "ุงุฌุงุฏ virtual environment..."
    python3 -m venv venv
fi

# ูุนุงูโุณุงุฒ venv
source venv/bin/activate

# ูุตุจ requirements
echo "ูุตุจ ูุงุจุณุชฺฏโูุง..."
pip install --quiet -r requirements.txt

echo -e "${GREEN}โ Backend ุขูุงุฏู ุงุณุช${NC}"
echo ""

# ================================================================================
# 5. ุงุฌุงุฏ ุฌุฏุงูู ุฏุชุงุจุณ
# ================================================================================
echo -e "${BLUE}๐จ ุงุฌุงุฏ ุฌุฏุงูู ุฏุชุงุจุณ...${NC}"
python -c "
import asyncio
from app.core.database import init_db

async def main():
    await init_db()
    print('โ ุฌุฏุงูู ุงุฌุงุฏ ุดุฏูุฏ')

asyncio.run(main())
"
echo ""

# ================================================================================
# 6. ููุงุด ุงุทูุงุนุงุช
# ================================================================================
echo ""
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}๐ ุณุงูุงูู ุจุง ููููุช ุฑุงูโุงูุฏุงุฒ ุดุฏ!${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""
echo -e "${BLUE}๐ ุงุทูุงุนุงุช ุฏุณุชุฑุณ:${NC}"
echo ""
echo "  ๐ ุขุฏุฑุณ ุณุงูุงูู:"
echo "     http://localhost:8000"
echo ""
echo "  ๐ ูุณุชูุฏุงุช API:"
echo "     http://localhost:8000/docs"
echo ""
echo "  ๐ ุตูุญู ูุฑูุฏ:"
echo "     http://localhost:8000/login.html"
echo ""
echo "  ๐ ุฏุงุดุจูุฑุฏ:"
echo "     http://localhost:8000/dashboard.html"
echo ""
echo -e "${YELLOW}๐ ุญุณุงุจ ุชุณุช:${NC}"
echo "     ุงูู: demo@hospital.com"
echo "     ุฑูุฒ: Demo@1234"
echo ""
echo -e "${BLUE}๐ ุจุฑุง ุงุฌุฑุง ุณุฑูุฑ:${NC}"
echo "     cd backend"
echo "     source venv/bin/activate"
echo "     uvicorn app.main:app --reload --host 0.0.0.0 --port 8000"
echo ""
echo -e "${BLUE}๐ ุจุฑุง ุชููู:${NC}"
echo "     docker-compose down"
echo ""
echo -e "${GREEN}โจ ูููู ุจุงุดุฏ!${NC}"
echo ""
